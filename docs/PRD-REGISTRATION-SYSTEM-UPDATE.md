# Product Requirements Document: Registration System Update

## Overview
Update the registration system to properly handle organisation_id mapping, add raw_payloads logging to the new route, ensure proper ticket creation for lodge registrations, and align the payment flow with the edge function requirements for confirmation number generation.

## Background
- The system has two registration types: individuals and lodge
- Individual registrations track individual attendees with tickets
- Lodge registrations track bulk orders without individual attendee details but still need tickets
- Confirmation numbers are generated by an edge function that monitors the registrations table
- The edge function triggers when status='completed' AND payment_status='completed'

## Requirements

### 1. Organisation ID Mapping
- **Individual Registrations**: The organisation_id in the registrations table should be the lodge's organisation_id of the primary attendee (if they are a Mason)
- **Lodge Registrations**: The organisation_id should be the organisation_id of the selected lodge from the LodgesForm

### 2. Lodge and Grand Lodge Data Enhancement
- When looking up lodges and grand lodges, fetch:
  - lodge_id (existing)
  - organisation_id (new requirement)
  - grand_lodge_id (existing)
  - For grand lodges: also fetch their organisation_id

### 3. Raw Payloads Logging
- Add raw_payloads logging to the new active route (`/api/functions/[functionId]/packages/[packageId]/lodge-registration`)
- This matches the behavior of the legacy route for debugging purposes

### 4. Ticket Creation for Lodge Registrations
- Lodge registrations must create tickets even though they don't create individual attendee records
- Tickets should be created based on the table_count * 10 (attendees per table)
- Tickets need to be linked to the registration_id

### 5. Confirmation Number Handling
- API and RPC must NOT create or update confirmation numbers directly
- Confirmation numbers should only be read from views after edge function generation
- Include confirmation number in response if available from views

### 6. Payment Flow Update
- Step 1: Create registration with status='pending' and payment_status='pending'
- Step 2: Process Stripe payment
- Step 3: If payment successful, update registration with status='completed' and payment_status='completed'
- Step 4: Wait for edge function to generate confirmation number
- Step 5: Return response with confirmation number (if available from view)

## Technical Specifications

### Database Schema Considerations
- registrations.organisation_id: UUID reference to organisations table
- lodges table has organisation_id column linking to organisations
- grand_lodges table should have organisation_id column
- tickets table needs registration_id column for lodge bulk tickets

### API Response Format
- Include confirmation_number only if available from views
- Do not attempt to generate or update confirmation numbers in API/RPC

### Edge Function Trigger Conditions
- Monitors registrations table for new/updated records
- Triggers when BOTH:
  - status = 'completed'
  - payment_status = 'completed'

## Success Criteria
1. Organisation IDs correctly mapped for both registration types
2. Raw payloads logged for all registration API calls
3. Tickets created for lodge registrations without attendee records
4. Confirmation numbers only read from views, never generated in API/RPC
5. Payment flow properly sets status fields to trigger edge function

## Out of Scope
- Modifying the edge function behavior
- Changing the confirmation number format
- Modifying existing individual registration flow beyond organisation_id mapping