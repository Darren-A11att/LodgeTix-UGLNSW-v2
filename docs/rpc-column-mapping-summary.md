# RPC Column Mapping Summary

## Overview
This document summarizes the column mapping issues in the `create_registration` RPC function and the solution implemented.

## Issue
The database schema has inconsistent column naming conventions:
- Some tables use camelCase (e.g., `attendees` table with `attendeeid`, `registrationid`)
- Some tables use snake_case (e.g., `tickets` table with `attendee_id`, `registration_id`)
- The RPC function expects snake_case input but needs to map to the actual database column names

## Database Schema Analysis

### Attendees Table (camelCase columns)
```sql
attendees (
  attendeeid: UUID
  registrationid: UUID
  attendeetype: attendee_type
  contactpreference: attendee_contact_preference
  dietaryrequirements: TEXT
  specialneeds: TEXT
  eventtitle: TEXT
  person_id: UUID
  relatedattendeeid: UUID
  relationship: TEXT
  createdat: TIMESTAMP
  updatedat: TIMESTAMP
)
```

### Tickets Table (snake_case columns)
```sql
tickets (
  ticket_id: UUID
  registration_id: UUID
  attendee_id: UUID
  event_id: UUID
  event_ticket_id: UUID
  ticket_definition_id: UUID
  package_id: UUID
  price_paid: NUMERIC
  status: TEXT
  created_at: TIMESTAMP
  updated_at: TIMESTAMP
)
```

### Registrations Table (snake_case columns)
```sql
registrations (
  registration_id: UUID
  customer_id: UUID
  event_id: UUID
  registration_type: registration_type
  status: TEXT
  payment_status: payment_status
  total_amount_paid: NUMERIC
  total_price_paid: NUMERIC
  agree_to_terms: BOOLEAN
  registration_data: JSONB[]
  confirmation_number: TEXT (auto-generated by trigger)
)
```

## Solution

### 1. Frontend (registration-rpc.ts)
The frontend sends data in snake_case format as expected by the RPC function:

```typescript
// Attendee data format
{
  attendee_id: UUID,
  attendee_type: 'mason' | 'guest',
  is_primary: boolean,
  dietary_requirements: string,
  special_needs: string,
  contact_preference: string,
  relationship: string,
  related_attendee_id: UUID,
  event_title: string,
  // ... other fields
}

// Ticket data format
{
  attendee_id: UUID,
  event_ticket_id: UUID,
  ticket_definition_id: UUID,
  package_id: UUID,
  price_paid: number,
  ticket_type: string,
  metadata: object
}
```

### 2. RPC Function Mapping
The RPC function maps snake_case input to the actual database column names:

```sql
-- For attendees table (camelCase columns)
INSERT INTO attendees (
  attendeeid,         -- from attendee_id
  registrationid,     -- from registration_id
  attendeetype,       -- from attendee_type
  contactpreference,  -- from contact_preference
  dietaryrequirements,-- from dietary_requirements
  specialneeds,       -- from special_needs
  relatedattendeeid,  -- from related_attendee_id
  eventtitle,         -- from event_title
  -- ... etc
)

-- For tickets table (already snake_case)
INSERT INTO tickets (
  ticket_id,          -- direct mapping
  registration_id,    -- direct mapping
  attendee_id,        -- direct mapping
  -- ... etc
)
```

## Key Points

1. **Input Format**: Always use snake_case when calling the RPC function
2. **Column Mapping**: The RPC function handles the mapping to actual database column names
3. **Error Handling**: The function includes proper error handling for column mismatches
4. **Return Format**: The function returns data in snake_case format

## Migration History

1. Initial RPC function assumed all tables used snake_case
2. Database schema revealed mixed naming conventions
3. Multiple migration attempts to fix column names
4. Final solution: Keep existing schema, fix mapping in RPC function

## Testing Checklist

- [ ] Test registration creation with individual attendees
- [ ] Test registration creation with lodge attendees
- [ ] Test registration creation with delegation attendees
- [ ] Test Mason profiles creation
- [ ] Test ticket assignment for packages
- [ ] Test ticket assignment for individual events
- [ ] Verify confirmation number generation
- [ ] Verify payment status updates