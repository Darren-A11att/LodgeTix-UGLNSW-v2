# Lodge Registration API Update Summary

## Overview
This document summarizes the necessary changes to the Lodge Registration API to remove dependency on `upsert_lodge_registration` RPC function and align with the confirmation number generation pattern used for individuals registration.

## Key Changes Required

### 1. Remove RPC Function Dependency
The current implementation relies on `upsert_lodge_registration` RPC function which:
- May not exist in the database
- Generates confirmation numbers (which should be done by Edge Function)
- Is not documented in migrations

### 2. Use Direct Database Operations
Replace RPC calls with direct Supabase operations:

#### For POST (Create Registration)
```typescript
// Instead of:
const { data: rpcResult, error: rpcError } = await supabase
  .rpc('upsert_lodge_registration', rpcPayload);

// Use direct inserts:
// 1. Create/update customer
const { data: customer, error: customerError } = await supabase
  .from('customers')
  .upsert({
    customer_id: customerId,
    customer_type: 'lodge',
    first_name: billingDetails.firstName,
    last_name: billingDetails.lastName,
    email: billingDetails.emailAddress,
    phone: billingDetails.mobileNumber,
    business_name: lodgeDetails.lodgeName,
    // ... other fields
  })
  .select()
  .single();

// 2. Create booking contact
const { data: bookingContact, error: contactError } = await supabase
  .from('contacts')
  .insert({
    contact_id: gen_random_uuid(),
    type: 'customer',
    first_name: billingDetails.firstName,
    last_name: billingDetails.lastName,
    email: billingDetails.emailAddress,
    mobile_number: billingDetails.mobileNumber,
    auth_user_id: customerId,
    // ... other fields
  })
  .select()
  .single();

// 3. Create registration
const { data: registration, error: regError } = await supabase
  .from('registrations')
  .insert({
    registration_id: registrationId || gen_random_uuid(),
    customer_id: customerId,
    auth_user_id: customerId,
    function_id: functionId,
    booking_contact_id: bookingContact.contact_id,
    registration_type: 'lodge',
    confirmation_number: null, // Edge Function will generate
    payment_status: 'pending',
    status: 'pending',
    total_amount_paid: totalAmount,
    subtotal: subtotal,
    stripe_fee: stripeFee,
    stripe_payment_intent_id: paymentIntentId,
    registration_data: {
      lodgeDetails,
      packageId,
      tableCount,
      billingDetails,
      agreeToTerms
    }
  })
  .select()
  .single();

// 4. Create attendees (if provided)
// 5. Create tickets/packages
```

#### For PUT (Update Payment Status)
```typescript
// Instead of RPC call, use direct update:
const { data, error } = await supabase
  .from('registrations')
  .update({
    payment_status: 'completed',
    status: 'completed', // This triggers Edge Function
    stripe_payment_intent_id: paymentIntentId,
    total_amount_paid: totalAmountPaid,
    updated_at: new Date().toISOString()
  })
  .eq('registration_id', registrationId)
  .select()
  .single();

// Return without confirmation number (will be generated by Edge Function)
return NextResponse.json({
  success: true,
  registrationId: data.registration_id,
  confirmationNumber: null // Frontend will poll for this
});
```

### 3. Response Format Changes
Update the response to not include confirmation number on creation:

```typescript
// Current response includes confirmationNumber
return NextResponse.json({
  success: true,
  registrationId: rpcResult.registrationId,
  confirmationNumber: rpcResult.confirmationNumber, // Remove this
  // ...
});

// New response
return NextResponse.json({
  success: true,
  registrationId: registration.registration_id,
  registrationData: {
    registration_id: registration.registration_id,
    customer_id: registration.customer_id,
    registration_type: 'lodge',
    // Don't include confirmation_number
  }
});
```

### 4. Frontend Integration
The frontend already handles waiting for confirmation numbers via `PaymentCompletionService`, so no changes needed there.

## Implementation Steps

1. **Create new version of lodge route** that uses direct database operations
2. **Test thoroughly** to ensure all data is saved correctly
3. **Update any references** to the old RPC function
4. **Document the changes** for the team

## Benefits

1. **Consistency**: Aligns with individuals registration pattern
2. **Reliability**: No dependency on undocumented RPC functions
3. **Maintainability**: All logic visible in the API route
4. **Edge Function Compatible**: Proper trigger for confirmation number generation

## Testing Checklist

- [ ] Create new lodge registration
- [ ] Verify all data saved correctly (customer, contact, registration)
- [ ] Complete payment
- [ ] Verify status updated to 'completed'
- [ ] Verify Edge Function generates confirmation number
- [ ] Verify email sent with confirmation number
- [ ] Test error scenarios